<!DOCTYPE html>
<html lang="en">

<head>
    <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>
    <meta charset="UTF-8">
    <title>Merge Sort Level 2</title>
    <link rel="stylesheet" href="/css/JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
    <style>
        #av {
            margin-top: 5%;
            width: 80%;
            position: relative;
        }

        .jsavlabel {
            font-size: 100%;
            text-align: center;
            margin: 30px 0 10px 0;
        }

        .jsavedgelabel {
            font-size: 100%;
            margin: 0;
        }

        .button {
            display: block;
            background-color: dodgerblue;
            border: 2px solid dodgerblue;
            color: white;
            font-size: 24px;
            border-radius: 6px;
            margin: 5px;
            font-family: 'Open Sans';
        }

        .button:hover {
            background-color: white;
            color: dodgerblue;
            border: 2px solid DodgerBlue;
        }

        .navButton {
            background-color: dodgerblue;
            border: 2px solid dodgerblue;
            color: white;
            font-size: 24px;
            width: 100px;
            border-radius: 6px;
            margin: 5px;
            font-family: 'Open Sans';
        }

        .navButton:hover {
            background-color: white;
            color: dodgerblue;
            border: 2px solid DodgerBlue;
        }
        .restart-button {
            background-color: dodgerblue;
            border: 2px solid dodgerblue;
            color: white;
            font-size: 24px;
            border-radius: 6px;
            margin: 5px;
            font-family: 'Open Sans';
            position: relative;
            left: 230px;
            top: auto;

        }

        .restart-button:hover {
            background-color: white;
            color: dodgerblue;
            border: 2px solid DodgerBlue;
        }

        .text{
            font-family: 'Open Sans';
            color: dodgerblue;
            font-size: 24px;
        }

        .inputBox{
            border-color: dodgerblue;
            border: 2px solid dodgerblue;
            border-radius: 6px;
            font-family: "Open Sans";
            color: dodgerblue;
            font-size: 24px;
        }
    </style>
</head>

<body style="background-color:DodgerBlue;">

    <center>
        <h1 style="color:white; font-family: 'Open Sans';">Learn Merge Sort</h1>
        <div style="width: 600px; height: auto;border-radius: 25px; background: white;margin:0 auto;">
            <br />
            <button id="menu" class="button" onclick="location.href = '/mergesort.html'">Menu</button>
            <button id='startbtn' class='button' onclick='javascript:getArray(); getArray2();'>Start</button>

            <div></div>

            <!-- <button id='sortBtn' onclick=getArray2()>Sort</button> -->
            <button id='nextBtn' class='button'> Next </button>
                       
            <div id='av' hidden></div>

            <div></div>
            <!-- use this button instead for part of restart functionality -->
            <button id='split' class='navButton' onclick="javascript:handleSplitClicked();">Split</button>
            <button id='merge' class='navButton' onclick="javascript:handleMergeForm();">Merge</button>
            <form action="javascript:handleMergeClicked();" id="arrayInputForm">
                <label for="arrayInput" id="arrayInputLabel" class="text">Merged Array:</label>
                <input type="number" id="arrayInput" name="array" class="inputBox">
                <input type="submit" value="Submit" id="mergeNum" class="navButton"><br/>
            </form>
            <button id='restart' class='restart-button' onclick='javascript:restart();'>Restart</button>
            <br /><br />
        </div>

    </center>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script src='/lib/jquery.transit.js'></script>
    <script src='/lib/raphael.js'></script>
    <script src='/build/jsav.js'></script>

    <script>
        let originalArr = [];
        let stepLists = [];

        let jsav = new JSAV("av");
        let instructionLabel;
        let nextInstructionLabel;
        let originalList;


        let curStepArr = '';
        let curInstruction = '';
        let curStepNo = 0;

        let nextStepArr = '';
        let nextInstruction = '';
        let nextStepNo = 1;

        let instruct = [];
        let stepNo = [];
        let stepArr = [];

        $(document).ready(function () {
            $("#restart").hide();
            $("#split").hide();
            $("#merge").hide();
            $("#arrayInputForm").hide();
        });

        // originalList.highlight(2);
        // originalList.css(4, { "background-color": "aqua", "color": "rgb(150, 55, 50)" });
        // originalList.layout();

        //displays unsorted array 
        function getArray() {
            let xReq = new XMLHttpRequest();
            xReq.onreadystatechange = displayArray;

            xReq.open('GET', '/array', true);
            xReq.send();
        }

        function displayArray() {
            // ensures ready state is met before running
            if (this.readyState == 4 && this.status == 200) {
                originalArr = [];
                stepLists = [];
                document.getElementById('startbtn').style.visibility = "hidden";

                this.responseText.split(',').forEach(element => {
                    originalArr.push(parseInt(element))
                });

                originalList = jsav.ds.array(originalArr);
                instructionLabel = jsav.label('Starting Array');
                nextInstructionLabel = jsav.label('Next: ');
                $('#av').show();
                $('#split').show();
                $('#merge').show();
            }
        }

        //displays steps when the sort button is pressed 
        function getArray2() {
            let xReq = new XMLHttpRequest();
            xReq.onreadystatechange = displayArray2;

            xReq.open('GET', '/array2', true);
            xReq.send();
        }

        function displayArray2() {
            if (this.readyState == 4 && this.status == 200) {
                let instructions = JSON.parse(this.responseText);

                for (i in instructions) {
                    if (i % 2 == 0) {
                        instruct.push(instructions[i].instruction);
                        stepNo.push(instructions[i].stepNo);
                    } else {
                        stepArr.push(instructions[i]);
                    }
                }

                ///////////////////////////////////////////////////////////////////////////////////
                let waitForPressResolve;
                function waitForPress() {
                    return new Promise(resolve => waitForPressResolve = resolve);
                }

                const btn = document.getElementById('nextBtn');

                function btnResolver() {
                    if (waitForPressResolve) waitForPressResolve();
                }

                async function doIt() {
                    btn.addEventListener('click', btnResolver);

                    for (p in stepArr) {
                        p = parseInt(p)
                        await waitForPress();
                        curInstruction = instruct[p];
                        curStepArr = stepArr[p];
                        curStepNo = stepNo[p];

                        try {
                            nextInstruction = 'Next: ' + instruct[p + 1];
                            nextStepArr = stepArr[p + 1];
                            nextStepNo = stepNo[p + 1];
                        }
                        catch {
                            nextInstruction = ''
                            nextStepArr = ''
                            nextStepNo = 0
                        }

                        instructionLabel.text(curInstruction)
                        nextInstructionLabel.text(nextInstruction)

                        for (let arr of stepLists) {
                            arr.clear();
                        }
                        for (let arr of curStepArr) {
                            let stepArr = [];
                            try {
                                arr.split(',').forEach(element => {
                                    stepArr.push(parseInt(element))
                                });
                            }
                            catch {
                                arr.forEach(element => { stepArr.push(element) });
                            }
                            stepLists.push(jsav.ds.array(stepArr));
                        }
                        $("span:contains('NaN')").text('');

                    }
                    btn.removeEventListener('click', btnResolver);
                    // alert('Finished');
                    $("#restart").show();
                }
                doIt();
            }
        }

        function restart() {
            $('.jsavarray').remove();
            $('.jsavlabel').remove();
            $('#restart').hide();
            for (let arr of stepLists) {
                arr.clear();
            }

            getArray();
            getArray2();
        }

        function handleValidation(isCorrect) {
            if(isCorrect) {
                handleCorrect(); ///TODO: triple check for parameters
            } else {
                handleIncorrect();
            }
        }
        
        function handleSplitClicked() {
            handleValidation(nextStepNo === 2);
        }

        function handleMergeForm(){
            $("#arrayInputForm").show();
        }
        function handleMergeClicked() {
            handleValidation(nextStepNo === 5 || nextStepNo === 6); 
            
            let num = document.getElementById("mergeNum");
            console.log(num);
            handleUserInput(num);           
        }

        function handleUserInput(value) {
            console.log(value);
            // check if the user inputs the next value which is supposed to be added to the array
            lastNonNull = nextStepArr[0].filter(x => x != null).slice(-1)[0];
            handleUserInput(value === lastNonNull);
        }
    </script>

</html>